# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

K4 Classical League is a Next.js 15 web application for managing a Swiss system chess tournament. The application handles player registration with admin approval, bye request management, game result submission with PGN notation, and tournament administration.

**Key Tournament Details:**
- Swiss system format, 7 rounds, 30+30 time control
- External pairings via swissystem.org
- Multi-season support (currently Season 2)
- Expected scale: ~50 players per season

## Commands

**Development:**
- `npm run dev` - Start development server with Turbopack (**NEVER RUN THIS - User runs in separate terminal**)
- `npm run build` - Build for production with Turbopack
- `npm run start` - Start production server
- `npm run lint` - Run ESLint

**CRITICAL: NEVER run `npm run dev` - The user always runs this in a separate terminal window. If you need to check if the dev server is running, ask the user to run it.**

**Local Setup (for first time or reset):**
- `npm run setup:local` - **RECOMMENDED**: Fully automated local environment setup
- `npm run setup:manual` - Manual setup (requires Prisma dev server already running)

**Database Development:**
- `npm run db:dev` - Start Prisma dev server (named instance: classical-league)
- `npm run db:dev:stop` - Stop Prisma dev server
- `npm run db:dev:remove` - Remove local database instance completely
- `npm run db:migrate:dev` - Create new migration (development only)
- `npm run db:migrate:deploy` - Deploy pending migrations (production)
- `npm run db:seed` - Seed database with initial data
- `npm run db:studio` - Open Prisma Studio
- `npm run db:push` - Push schema changes without migration (prototyping only)
- `npx prisma generate` - Generate Prisma client

**Statistics Generation:**
- `node scripts/generate-stats.js --round <number>` - Generate stats JSON for a round
- `node scripts/generate-overview.js --season <number>` - Generate season overview (aggregates all rounds)
- Stats piped from API URL or local PGN file
- Output to `public/stats/season-<N>-round-<N>.json` and `public/stats/season-<N>-overview.json`
- Example workflow:
  ```bash
  # Generate round stats from API (recommended)
  curl -s "https://classical.schachklub-k4.ch/api/broadcast/round/{roundId}/pgn" | \
    node scripts/generate-stats.js --round 1

  # From local file (basic stats)
  cat round1.pgn | node scripts/generate-stats.js --round 1

  # From local file with Stockfish analysis (recommended)
  cat round1.pgn | node scripts/generate-stats.js --round 1 --analyze

  # Generate season overview (after 2+ rounds completed)
  node scripts/generate-overview.js --season 2

  # View generated stats
  # Round stats: public/stats/season-2-round-1.json → http://localhost:3000/stats/round/1
  # Season overview: public/stats/season-2-overview.json → http://localhost:3000/stats/overview
  ```

**GitHub Actions (Automated Stats):**
- `.github/workflows/weekly-analysis.yml` - Automated round analysis every Wednesday 12pm UTC
- `.github/workflows/generate-overview.yml` - Season overview generation every Wednesday 2pm UTC
- `.github/workflows/analyze-round.yml` - Manual single round analysis
- `.github/workflows/analyze-multiple-rounds.yml` - Batch analysis for multiple rounds

**Round Detection:**
- `node scripts/detect-current-round.js` - Auto-detect which round to analyze
- Outputs JSON with roundId, roundNumber, gameCount, and completion status
- Used by automated workflows to determine analysis targets

**Manual Workflow Triggers:**
```bash
# Trigger weekly analysis manually (GitHub CLI)
gh workflow run weekly-analysis.yml

# Analyze specific round
gh workflow run analyze-round.yml -f round=1 -f season=2 -f depth=15

# Batch analyze multiple rounds
gh workflow run analyze-multiple-rounds.yml -f rounds="1,2,3" -f season=2

# Generate season overview
gh workflow run generate-overview.yml -f season=2

# View workflow runs
gh run list --workflow=weekly-analysis.yml
gh run watch <run-id>
```

**Workflow Schedule (Weekly):**
Every Wednesday at 12pm UTC, stats are generated:
- **Day after round starts** (e.g., Wed Oct 23 after Tue Oct 21 start): Final stats for PREVIOUS round
- **Mid-round** (e.g., Wed Oct 30): In-progress stats for CURRENT round
- **Overview**: Runs 2 hours after analysis (2pm UTC) every Wednesday

Example Timeline:
```
Tue Oct 21: Round 3 starts
Wed Oct 23 12pm: Final stats for Round 2 + overview
Wed Oct 30 12pm: In-progress stats for Round 3 (mid-round)
Tue Nov 4:  Round 4 starts
Wed Nov 6 12pm:  Final stats for Round 3 + overview
Wed Nov 13 12pm: In-progress stats for Round 4 (mid-round)
```

**Required GitHub Secrets:**
- `DATABASE_URL` - Neon PostgreSQL connection string for round detection and PGN fetching

**Git:**
- Keep commit messages concise and descriptive
- **NEVER** include "Generated by AI", "Co-authored-by: Claude", "🤖 Generated with [Claude Code]", or similar AI attribution in commit messages (Important!)
- ALWAYS run `npm run build` before pushing to main to ensure the build is working

## Architecture Overview

### Tech Stack
- **Frontend:** Next.js 15 App Router, React 19, TailwindCSS 4
- **Backend:** Next.js API routes, Prisma ORM, PostgreSQL
- **Authentication:** NextAuth.js with credentials provider
- **Deployment:** Vercel (recommended)

### Database Architecture
The application uses Prisma with PostgreSQL and follows a multi-season tournament model:

- **Season** - Tournament seasons with start/end dates
- **Player** - User registrations with approval workflow  
- **Round** - Tournament rounds with bye deadlines
- **ByeRequest** - Player bye requests with admin approval
- **GameResult** - Game results with board numbers and PGN notation
- **Admin** - Administrative users with authentication

### Key Design Patterns

**Admin Approval Workflows:**
- Player registration requires admin approval before appearing in directory
- Bye requests require admin approval before Wednesday noon deadlines
- Game results require admin verification and player assignment

**Multi-Season Support:**
- All player data is scoped to seasons
- Email/nickname uniqueness enforced per season
- Season management through admin panel

**Authentication Architecture:**
- NextAuth.js with custom credentials provider
- Admin-only authentication (single role)
- JWT sessions with 8-hour expiry
- Server-side session validation in admin layouts

### File Structure

**Core Application:**
- `/app` - Next.js App Router pages and API routes
- `/components` - Reusable React components with navigation
- `/lib` - Utilities, database client, auth configuration
- `/prisma` - Database schema and seed files

**Key Components:**
- `components/navigation.tsx` - Public site navigation with mobile flyout
- `components/admin-navigation.tsx` - Admin panel navigation
- `lib/auth-config.ts` - NextAuth.js configuration
- `lib/nickname-generator.ts` - Creative chess nickname generation
- `lib/validations.ts` - Zod schemas for form validation

**Statistics System:**
- `/app/stats/` - Stats landing page with season overview
- `/app/stats/overview/` - Season overview page (Hall of Fame, Leaderboards, Trends, Piece Cemetery)
- `/app/stats/round/[roundNumber]` - Dynamic round statistics pages
- `/components/stats/` - 15 modular round statistics components
- `/components/stats/overview/` - 5 season overview components
- `/scripts/generate-stats.js` - Round stats generator script
- `/scripts/generate-overview.js` - Season overview generator script
- `/scripts/utils/` - PGN parsing, game analysis, opening database utilities
- `/scripts/utils/overview/` - Overview aggregation utilities
- See `STATS.md` and `STATS-PROGRESS.md` for implementation details

## Database Migration Workflow

**CRITICAL:** Always follow this exact workflow for database changes:

### Development (Local)
1. **Modify Schema**: Edit `prisma/schema.prisma` with your changes
2. **Create Migration**: Run `npm run db:migrate:dev` and provide descriptive name
3. **Test Locally**: Verify changes work with `npm run dev` and `npm run db:studio`
4. **Commit**: Add migration files and schema to git

### Production Deployment
1. **Push to Main**: Vercel automatically runs `vercel-build` script
2. **Auto-Migration**: Script includes `prisma migrate deploy` before build
3. **Verify**: Check Vercel logs for successful migration deployment

### Important Rules
- **NEVER** use `db:push` in production - only for local prototyping
- **ALWAYS** test migrations locally first with shadow database
- **NEVER** edit existing migration files - create new ones to fix issues
- **ALWAYS** make migrations backward compatible when possible
- **NEVER** delete migration files from git
- **ALWAYS** handle nullable fields in TypeScript (e.g., `result.pgn ? cleanPGN(result.pgn) : ''`)

### Quick Commands
```bash
# Development workflow
npm run db:migrate:dev        # Create new migration
npm run db:studio             # Inspect database
npm run build                 # Test TypeScript compatibility

# Emergency troubleshooting
npx prisma migrate status     # Check migration status
npx prisma migrate resolve --applied "migration_name"  # Mark as applied

# Neon CLI (authenticated and available)
neon                          # Access Neon CLI for production database management
neon databases list           # List all databases
neon sql-editor              # Open SQL editor for direct queries
```

See `DATABASE_MIGRATIONS.md` for complete documentation.

## Development Notes

**Authentication Flow:**
- Login page at `/admin-auth` (outside admin layout to prevent redirect loops)
- Admin layout uses `getServerSession()` with auth config
- Session provider wraps entire app for client-side auth

**Form Validation:**
- Uses React Hook Form with Zod resolvers
- Phone numbers required for WhatsApp integration
- Nickname validation allows spaces, quotes, underscores, hyphens

**Mobile Design:**
- Mobile-first responsive design
- Flyout navigation menus for both public and admin sections
- TailwindCSS 4 with custom Syne font integration

**Data Patterns:**
- Swiss date formatting (`toLocaleDateString('de-CH')`) 
- Board number-based result entry (no player selection)
- PGN notation required for all game submissions
- Creative nickname generation with 47+ humorous chess phrases

**Environment Setup:**
- **Local Development**: Uses Prisma dev server (automated via `npm run setup:local`)
- **Production**: Neon serverless PostgreSQL
- Requires `DATABASE_URL`, `NEXTAUTH_SECRET`, `ADMIN_USERNAME`, `ADMIN_PASSWORD`, `POSTMARK_API_KEY`
- Postmark API for email notifications (sender: check@schachklub-k4.ch)
- Production deployment: Vercel at classical.schachklub-k4.ch

**Email Notifications:**
- Registration success, player approval, bye approval, round notifications
- Non-blocking email system to prevent API timeouts
- All email templates include tournament links from admin settings

## Local Development Setup

**Quick Start (First Time or Reset):**
```bash
npm run setup:local    # Automated: starts Prisma dev, sets up DB, seeds data
# In new terminal:
npm run dev           # Start Next.js development server
```

**Manual Setup (Alternative):**
```bash
# Terminal 1 (keep running):
npm run db:dev

# Terminal 2:
# Update .env with DATABASE_URL from Terminal 1 output
npm run setup:manual
npm run dev
```

**What Gets Created:**
- Prisma dev server on localhost with named instance `classical-league`
- `.env` file auto-updated with connection string
- Season 2 with 7 rounds (Sep-Dec 2025)
- 10 test players (Magnus Carlsen, Garry Kasparov, etc.)
- Admin user: `admin` / `SchachKreis4Admin2025!`

**Important Files:**
- `scripts/setup-env.js` - Automated setup script
- `scripts/local-setup.sh` - Manual setup script
- `LOCAL_SETUP.md` - Comprehensive setup documentation
- `.env` - Auto-generated environment variables

**Daily Workflow:**
- `npm run setup:local` (if starting fresh)
- **Ask user to run `npm run dev`** (NEVER run this yourself)
- Admin panel: http://localhost:3000/admin-auth

**Troubleshooting:**
- Reset everything: `npm run db:dev:stop && npm run setup:local`
- Database browser: `npm run db:studio`
- Check migrations: `npx prisma migrate status`

## Statistics System

The application includes a comprehensive statistics system that analyzes chess games from PGN data.

### Architecture

**Round Statistics Components** (15 modular components in `/components/stats/`):
  - `round-header.tsx` - Navigation and broadcast link
  - `overview-stats.tsx` - Game overview metrics
  - `results-breakdown.tsx` - Win/loss/draw with pie chart
  - `awards-section.tsx` - Tournament awards
  - `fun-stats.tsx` - 11 fun statistics (see below)
  - `game-phases.tsx` - Opening/middlegame/endgame analysis
  - `tactics-section.tsx` - Captures, castling, promotions
  - `openings-section.tsx` - ECO opening analysis with charts
  - `piece-stats.tsx` - Piece activity and survival rates
  - `notable-games.tsx` - Interesting games
  - `checkmates-section.tsx` - Checkmate analysis
  - `board-heatmap-section.tsx` - Interactive heatmap
  - `opening-popularity-chart.tsx` - Bar chart (recharts)
  - `win-rate-chart.tsx` - Pie chart (recharts)
  - `stat-card.tsx` - Reusable wrapper

**Season Overview Components** (5 components in `/components/stats/overview/`):
  - `overview-hero.tsx` - Season stats hero section
  - `piece-cemetery.tsx` - Creative graveyard with captured pieces
  - `hall-of-fame-section.tsx` - Best awards from all rounds
  - `leaderboards-section.tsx` - Player performance rankings
  - `trends-section.tsx` - Statistics trends across rounds

**Round Stats Utilities** (`/scripts/utils/`):
  - `pgn-parser.js` - Parse PGN with chess.js
  - `game-phases.js` - Detect opening/middlegame/endgame (Lichess approach)
  - `stats-calculator.js` - Calculate all statistics
  - `chess-openings.js` - ECO opening database (3,546 openings from Lichess)
  - `build-openings-db.js` - Build opening database from Lichess TSV files

**Season Overview Utilities** (`/scripts/utils/overview/`):
  - `load-round-data.js` - Load and validate round JSON files
  - `aggregate-totals.js` - Aggregate statistics across rounds
  - `find-hall-of-fame.js` - Extract best awards from all rounds
  - `track-players.js` - Track player appearances and performance
  - `calculate-trends.js` - Calculate round-by-round trends
  - `generate-leaderboards.js` - Generate player rankings

### Round Statistics Features
- **Game Analysis**: Overview, phases, results breakdown with visualizations
- **ECO Opening Classification**: 3,546+ openings from Lichess database (CC0 Public Domain)
- **Tactical Statistics**: Captures, castling, promotions, en passant
- **Board Heatmap**: Interactive visualization of square activity
- **Piece Statistics**: Activity, captures, survival rates
- **Stockfish Analysis**: Accuracy, blunders, mistakes, comebacks, lucky escapes
- **Fun Statistics** (11 awards):
  1. ⚡ Fastest Queen Trade
  2. 🐌 Slowest Queen Trade
  3. 🔪 Longest Capture Spree
  4. 👑 Longest King Hunt (checks)
  5. 🌪️ Pawn Storm Award
  6. 🏠 Piece Loyalty Award
  7. ✈️ Square Tourist Award
  8. 🏁 Castling Race Winner
  9. 🎩 Opening Hipster (most obscure opening)
  10. 👸 Sporty Queen (traveled most distance)
  11. 👑 Dadbod Shuffler (most active king)

### Season Overview Features
- **Aggregated Statistics**: Total games, moves, averages across all rounds
- **Piece Cemetery**: Creative graveyard theme with all captured pieces (1,100+ pieces)
- **Hall of Fame**: Best awards from all rounds (Bloodbath, Speed Demon, etc.)
- **Player Leaderboards**: Most games, most wins, highest accuracy, etc.
- **Trends Analysis**: Round-by-round visualization of key metrics
- **Player Stats Tracking**: Individual player performance across season

### Performance
- ✅ 100% PGN parsing success rate (31/31 games Round 1, 33/33 games Round 2)
- ✅ Round stats: generates in 30-45s (basic), 7-15min (with Stockfish analysis)
- ✅ Season overview: generates in <5s (aggregates existing round data)
- ✅ Output files: 35-66KB per round, ~50KB for overview
- ✅ Static JSON for fast page loads
- ✅ Dark mode support throughout

### Generating Statistics
```bash
# Generate round stats from API (recommended)
curl -s "https://classical.schachklub-k4.ch/api/broadcast/round/{roundId}/pgn" | \
  node scripts/generate-stats.js --round 1 --analyze

# From local PGN file
cat round1.pgn | node scripts/generate-stats.js --round 1 --analyze

# Generate season overview (after 2+ rounds completed)
node scripts/generate-overview.js --season 2

# Output files:
# - Round stats: public/stats/season-2-round-1.json → http://localhost:3000/stats/round/1
# - Season overview: public/stats/season-2-overview.json → http://localhost:3000/stats/overview
```

## Development Workflow

**For New Features:**
1. Check `/PROJECT_SPEC.md` for requirements and data models
2. Update Prisma schema if database changes needed
3. Follow existing patterns for admin approval workflows
4. Use mobile-first TailwindCSS design approach
5. Test admin authentication and approval flows

**For Bug Fixes:**
1. Test with development server running (`npm run dev`)
2. Check both public and admin interfaces
3. Verify mobile responsiveness
4. Test authentication flows and session management

**For Statistics Updates:**
1. Modify stats calculator in `/scripts/utils/stats-calculator.js`
2. Update TypeScript interfaces in `/app/stats/round/[roundNumber]/page.tsx`
3. Create/modify components in `/components/stats/`
4. Test with `npm run build` to ensure type safety
5. Regenerate stats JSON with updated script
6. View changes at http://localhost:3000/stats/round/1