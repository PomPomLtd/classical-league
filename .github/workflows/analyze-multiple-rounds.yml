name: Analyze Multiple Rounds (Parallel)

on:
  workflow_dispatch:
    inputs:
      rounds:
        description: 'Comma-separated round numbers (e.g., "1,2,3")'
        required: true
        type: string
      season:
        description: 'Season number (default: 2)'
        required: false
        default: '2'
        type: number
      depth:
        description: 'Stockfish depth (default: 15)'
        required: false
        default: '15'
        type: number

jobs:
  analyze:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      matrix:
        round: ${{ fromJson(format('[{0}]', github.event.inputs.rounds)) }}
      max-parallel: 3  # Analyze 3 rounds simultaneously
    timeout-minutes: 120  # 2 hours per round

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Node dependencies
        run: npm ci

      - name: Install Stockfish
        run: |
          sudo apt-get update
          sudo apt-get install -y stockfish
          stockfish --version

      - name: Install Python dependencies
        run: |
          pip3 install python-chess stockfish

      - name: Fetch PGN for Round ${{ matrix.round }}
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          SEASON=$((${{ github.event.inputs.season }}))
          ROUND=$((${{ matrix.round }}))

          echo "Fetching PGN for Season $SEASON Round $ROUND"

          # Get round ID from database
          ROUND_ID=$(node -e "
            const { PrismaClient } = require('@prisma/client');
            const prisma = new PrismaClient();

            (async () => {
              try {
                const season = await prisma.season.findFirst({
                  where: { seasonNumber: parseInt(process.argv[1]) }
                });

                if (!season) throw new Error('Season not found');

                const round = await prisma.round.findFirst({
                  where: {
                    seasonId: season.id,
                    roundNumber: parseInt(process.argv[2])
                  }
                });

                if (!round) throw new Error('Round not found');

                console.log(round.id);
              } finally {
                await prisma.\$disconnect();
              }
            })();
          " $SEASON $ROUND 2>/dev/null)

          if [ -z "$ROUND_ID" ]; then
            echo "❌ Round $ROUND not found in database"
            exit 1
          fi

          echo "Round ID: $ROUND_ID"

          # Fetch PGN from API endpoint
          PGN_URL="https://classical.schachklub-k4.ch/api/broadcast/round/${ROUND_ID}/pgn"
          echo "Fetching from: $PGN_URL"

          if ! curl -f -s "$PGN_URL" > /tmp/round-${ROUND}.pgn; then
            echo "❌ Failed to fetch PGN for Round $ROUND"
            exit 1
          fi

          if [ ! -s /tmp/round-${ROUND}.pgn ]; then
            echo "❌ Empty PGN file for Round $ROUND"
            exit 1
          fi

          echo "✅ PGN file ready ($(wc -l < /tmp/round-${ROUND}.pgn) lines)"

      - name: Analyze Round ${{ matrix.round }}
        run: |
          SEASON=$((${{ github.event.inputs.season }}))
          ROUND=$((${{ matrix.round }}))
          DEPTH=$((${{ github.event.inputs.depth }}))

          echo "Starting analysis for Season $SEASON Round $ROUND"
          echo "Depth: $DEPTH"
          echo "Start time: $(date)"

          cat /tmp/round-${ROUND}.pgn | \
            node scripts/generate-stats.js \
              --round $ROUND \
              --season $SEASON \
              --analyze \
              --depth $DEPTH

          echo "End time: $(date)"

      - name: Verify output
        run: |
          SEASON=$((${{ github.event.inputs.season }}))
          ROUND=$((${{ matrix.round }}))
          OUTPUT_FILE="public/stats/season-${SEASON}-round-${ROUND}.json"

          if [ -f "$OUTPUT_FILE" ]; then
            SIZE=$(du -h "$OUTPUT_FILE" | cut -f1)
            GAMES=$(jq -r '.overview.totalGames' "$OUTPUT_FILE")
            echo "✅ Round $ROUND: $SIZE ($GAMES games)"
          else
            echo "❌ Round $ROUND: File not generated"
            exit 1
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: stats-round-${{ matrix.round }}
          path: public/stats/season-${{ github.event.inputs.season }}-round-${{ matrix.round }}.json

  commit:
    needs: analyze
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Move artifacts to correct location
        run: |
          mkdir -p public/stats
          find artifacts -name "*.json" -exec cp {} public/stats/ \;
          ls -lh public/stats/

      - name: Commit results
        run: |
          SEASON=$((${{ github.event.inputs.season }}))
          DEPTH=$((${{ github.event.inputs.depth }}))
          ROUNDS="${{ github.event.inputs.rounds }}"

          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          git add public/stats/

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "$(cat <<'EOF'
          Add Stockfish analysis for Season $SEASON rounds: $ROUNDS

          Analyzed with depth $DEPTH
          Generated by parallel workflow
          EOF
          )"
            git pull --rebase
            git push
          fi
